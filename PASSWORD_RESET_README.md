# Восстановление и смена пароля

## Что реализовано

### 1. Восстановление пароля ("Забыли пароль?")
- Страница `/forgot-password` - запрос на восстановление
- Страница `/reset-password?token=...` - сброс пароля по токену из письма
- Токены действительны 1 час
- Токены одноразовые

### 2. Смена пароля
- Модальное окно в профиле (кнопка "Сменить пароль" в dropdown)
- Требует ввода текущего пароля
- Отправляет уведомление на email при успешной смене

## Установка и настройка

### 1. Установите зависимости

```bash
cd backend
npm install
```

### 2. Настройте переменные окружения

Создайте файл `backend/.env`:

```env
# SMTP настройки (пример для Gmail)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
EMAIL_FROM=your-email@gmail.com

# URL фронтенда (для ссылок в письмах)
FRONTEND_URL=https://your-domain.com
```

**Для Gmail:**
1. Включите двухфакторную аутентификацию
2. Создайте "Пароль приложения" в настройках Google
3. Используйте этот пароль в `SMTP_PASS`

Подробнее см. `backend/EMAIL_SETUP.md`

### 3. Запустите миграцию

```bash
cd backend/db
node migrate_password_reset.js
```

Это создаст таблицу `password_reset_tokens` для хранения токенов восстановления.

## API Эндпоинты

### POST /api/auth/forgot-password
Запрос на восстановление пароля.

**Body:**
```json
{
  "email": "user@example.com"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Если пользователь с таким email существует, на него будет отправлено письмо"
}
```

### POST /api/auth/reset-password
Сброс пароля по токену.

**Body:**
```json
{
  "token": "abc123...",
  "password": "newpassword123"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Пароль успешно изменен"
}
```

### POST /api/auth/change-password
Смена пароля для авторизованного пользователя (требует cookie).

**Body:**
```json
{
  "currentPassword": "oldpassword",
  "newPassword": "newpassword123"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Пароль успешно изменен"
}
```

## Фронтенд

### Страницы
- `/forgot-password` - форма запроса восстановления
- `/reset-password?token=...` - форма сброса пароля

### Компоненты
- `ChangePasswordModal` - модальное окно смены пароля (доступно из профиля)

## Безопасность

- Токены генерируются криптографически стойким способом (32 байта)
- Токены одноразовые (помечаются как использованные)
- Токены имеют срок действия (1 час)
- Пароли хешируются с помощью bcrypt
- При запросе восстановления всегда возвращается успех (защита от перебора email)

## Тестирование

1. Убедитесь, что email настроен (см. `EMAIL_SETUP.md`)
2. Перейдите на `/forgot-password`
3. Введите email и отправьте запрос
4. Проверьте почту и перейдите по ссылке
5. Введите новый пароль

Для смены пароля:
1. Войдите в систему
2. Откройте профиль (иконка пользователя)
3. Нажмите "Сменить пароль"
4. Введите текущий и новый пароль
