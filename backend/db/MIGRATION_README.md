# Миграция системы категорий

## Описание

Эта миграция добавляет систему умных категорий для расходов и доходов:

1. Создает таблицу `categories` с поддержкой синонимов
2. Добавляет поля `category_id` и `comment` в таблицу `finances`
3. Создает стандартные категории для всех пользователей
4. Мигрирует существующие данные

## Порядок выполнения

### 1. Создание таблицы categories и стандартных категорий

```bash
cd backend/db
node migrate_categories.js
```

Этот скрипт:
- Создает таблицу `categories`
- Добавляет поля `category_id` и `comment` в `finances`
- Создает стандартные категории для всех существующих пользователей

### 2. Миграция существующих записей finances

```bash
cd backend/db
node migrate_finances_categories.js
```

Этот скрипт:
- Находит все записи `finances` без `category_id`
- Пытается определить категорию по тексту через синонимы
- Заполняет `category_id` и сохраняет исходный текст в `comment`
- Если категория не найдена, помечает как "Прочее"

**Важно:** Перед запуском миграции finances можно:
1. Выгрузить все текущие категории из базы
2. Доработать маппинг `CATEGORY_MAPPING` в `migrate_finances_categories.js`
3. Запустить миграцию

## Стандартные категории

### Расходы:
- Продукты
- Еда вне дома
- Квартира и ЖКХ
- Транспорт
- Спорт
- Здоровье
- Развлечения
- Обучение
- Одежда
- Прочее

### Доходы:
- Зарплата
- Подработка
- Подарки
- Прочие доходы

## После миграции

1. **Telegram бот:** При вводе `-500 яндекс лавка` бот автоматически определит категорию "Продукты" и сохранит "яндекс лавка" как комментарий. Если категория не найдена, покажет кнопки для выбора.

2. **Веб-интерфейс:** В форме добавления транзакции появится выпадающий список категорий и поле для комментария.

3. **API:** Все эндпоинты `/api/finances` теперь возвращают `category_id`, `category_name` и `comment`.

## Откат миграции

Если нужно откатить изменения:

```sql
-- Удалить category_id и comment из finances (опционально, данные не потеряются)
-- ALTER TABLE finances DROP COLUMN category_id;
-- ALTER TABLE finances DROP COLUMN comment;

-- Удалить таблицу categories
-- DROP TABLE categories;
```

**Внимание:** Откат удалит все категории и связи, но исходные данные в поле `category` останутся.
